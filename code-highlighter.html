<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="highlight-import.html">

<dom-module id="code-highlighter">
  <template>
    <style include="code-highlighter-theme">
      :host {
        display: block;
      }

      pre { margin: 0; }
      pre, code {
        font-family: var(--code-highlighter-font-family, Operator Mono, Roboto Mono, monaco, consolas, monospace);
        font-size: var(--code-highlighter-font-size, 14px);
      }

      .hljs {
        padding: 0 20px;
        line-height: 1.3;
      }
    </style>

    <slot></slot>
    <pre id="code"></pre>
  </template>
  <script>
    (function() {
      'use strict';

      /* global hljs */

      class CodeHighlighter extends Polymer.Element {
        static get is() { return 'code-highlighter' }
        static get properties() {
          return {
            _content: {
              type: String,
              observer: '_contentChanged'
            },
            type: {
              type: String
            }
          }
        }

        constructor() {
          super();
        }

        connectedCallback() {
          super.connectedCallback();
          setTimeout(function() {
            if (this.querySelector('template')) {
              this._content = this.querySelector('template').innerHTML;
            } else {
              // TODO: check that there are childNodes
              console.error('content must be provided inside a <template> tag');
            }
          }.bind(this), 1);
        }

        _contentChanged(content) {
          var parsed = this._entitize(this._cleanIndentation(content));
          var code = document.createElement('code');
          code.classList.add(this.type);
          code.innerHTML = parsed;
          this.$.code.appendChild(code);
          hljs.highlightBlock(code);
          this.innerHTML = '';
        }

        _cleanIndentation(str) {
          var pattern = str.match(/\s*\n[\t\s]*/);
          return str.replace(new RegExp(pattern, "g"),'\n');
        }

        _entitize(str) {
          return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
      }

      customElements.define(CodeHighlighter.is, CodeHighlighter);
    }());
  </script>
</dom-module>
